services:
  semantika-api:
    build: .
    command: "uvicorn server:app --host 0.0.0.0 --port 8000 --workers 2"
    ports:
      - "8000:8000"
    environment:
      # Supabase Configuration
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_KEY=${SUPABASE_KEY}

      # Qdrant Configuration
      - QDRANT_URL=${QDRANT_URL}
      - QDRANT_API_KEY=${QDRANT_API_KEY}
      - QDRANT_COLLECTION_NAME=${QDRANT_COLLECTION_NAME:-semantika_prod}

      # OpenRouter Configuration
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
      - OPENROUTER_BASE_URL=${OPENROUTER_BASE_URL:-https://openrouter.ai/api/v1}
      - OPENROUTER_DEFAULT_MODEL=${OPENROUTER_DEFAULT_MODEL:-anthropic/claude-3.5-sonnet}
      - OPENROUTER_FAST_MODEL=${OPENROUTER_FAST_MODEL:-openai/gpt-4o-mini}

      # ScraperTech Configuration
      - SCRAPERTECH_API_KEY=${SCRAPERTECH_API_KEY:-}
      - SCRAPERTECH_BASE_URL=${SCRAPERTECH_BASE_URL:-https://api.scraper.tech}

      # Text Processing Configuration
      - CHUNK_SIZE=${CHUNK_SIZE:-1000}
      - CHUNK_OVERLAP=${CHUNK_OVERLAP:-200}
      - SIMILARITY_THRESHOLD=${SIMILARITY_THRESHOLD:-0.98}

      # TTL Configuration
      - DATA_TTL_DAYS=${DATA_TTL_DAYS:-30}

      # Server Configuration
      - API_HOST=${API_HOST:-0.0.0.0}
      - API_PORT=${API_PORT:-8000}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}

      # File Monitor Configuration
      - FILE_MONITOR_ENABLED=${FILE_MONITOR_ENABLED:-false}
      - FILE_MONITOR_WATCH_DIR=${FILE_MONITOR_WATCH_DIR:-/app/data/watch}
      - FILE_MONITOR_PROCESSED_DIR=${FILE_MONITOR_PROCESSED_DIR:-/app/data/processed}
      - FILE_MONITOR_INTERVAL=${FILE_MONITOR_INTERVAL:-30}

      # Email Monitor Configuration
      - EMAIL_MONITOR_ENABLED=${EMAIL_MONITOR_ENABLED:-false}
      - EMAIL_IMAP_SERVER=${EMAIL_IMAP_SERVER:-}
      - EMAIL_IMAP_PORT=${EMAIL_IMAP_PORT:-993}
      - EMAIL_ADDRESS=${EMAIL_ADDRESS:-}
      - EMAIL_PASSWORD=${EMAIL_PASSWORD:-}
      - EMAIL_MONITOR_INTERVAL=${EMAIL_MONITOR_INTERVAL:-60}
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8000/health', timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  semantika-scheduler:
    build: .
    command: "python scheduler.py"
    environment:
      # Same environment variables as API
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_KEY=${SUPABASE_KEY}
      - QDRANT_URL=${QDRANT_URL}
      - QDRANT_API_KEY=${QDRANT_API_KEY}
      - QDRANT_COLLECTION_NAME=${QDRANT_COLLECTION_NAME:-semantika_prod}
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
      - OPENROUTER_BASE_URL=${OPENROUTER_BASE_URL:-https://openrouter.ai/api/v1}
      - OPENROUTER_DEFAULT_MODEL=${OPENROUTER_DEFAULT_MODEL:-anthropic/claude-3.5-sonnet}
      - OPENROUTER_FAST_MODEL=${OPENROUTER_FAST_MODEL:-openai/gpt-4o-mini}
      - SCRAPERTECH_API_KEY=${SCRAPERTECH_API_KEY:-}
      - SCRAPERTECH_BASE_URL=${SCRAPERTECH_BASE_URL:-https://api.scraper.tech}
      - CHUNK_SIZE=${CHUNK_SIZE:-1000}
      - CHUNK_OVERLAP=${CHUNK_OVERLAP:-200}
      - SIMILARITY_THRESHOLD=${SIMILARITY_THRESHOLD:-0.98}
      - DATA_TTL_DAYS=${DATA_TTL_DAYS:-30}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - FILE_MONITOR_ENABLED=${FILE_MONITOR_ENABLED:-false}
      - FILE_MONITOR_WATCH_DIR=${FILE_MONITOR_WATCH_DIR:-/app/data/watch}
      - FILE_MONITOR_PROCESSED_DIR=${FILE_MONITOR_PROCESSED_DIR:-/app/data/processed}
      - FILE_MONITOR_INTERVAL=${FILE_MONITOR_INTERVAL:-30}
      - EMAIL_MONITOR_ENABLED=${EMAIL_MONITOR_ENABLED:-false}
      - EMAIL_IMAP_SERVER=${EMAIL_IMAP_SERVER:-}
      - EMAIL_IMAP_PORT=${EMAIL_IMAP_PORT:-993}
      - EMAIL_ADDRESS=${EMAIL_ADDRESS:-}
      - EMAIL_PASSWORD=${EMAIL_PASSWORD:-}
      - EMAIL_MONITOR_INTERVAL=${EMAIL_MONITOR_INTERVAL:-60}
    restart: unless-stopped
    depends_on:
      - semantika-api

  dozzle:
    image: amir20/dozzle:latest
    ports:
      - "8080:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      - DOZZLE_LEVEL=info
      - DOZZLE_TAILSIZE=300
    restart: unless-stopped
